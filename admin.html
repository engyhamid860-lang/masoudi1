<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø£Ø¯Ù…Ù†</title>

<style>
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:Arial;background:#0f172a;color:#fff;padding:20px}
.header{
  background:linear-gradient(135deg,#f7b500,#ffcc33);
  padding:20px;border-radius:20px;
  text-align:center;color:#000;margin-bottom:20px
}
.card{
  background:#1e293b;padding:15px;
  border-radius:15px;margin-bottom:12px
}
button{
  margin-top:6px;padding:6px 10px;
  border:none;border-radius:6px;
  cursor:pointer;color:#fff
}
.green{background:#16a34a}
.red{background:#dc2626}
.blue{background:#2563eb}
.orange{background:#ea580c}
input{padding:5px;border-radius:5px;border:none;margin-top:5px}
img{border-radius:8px}
</style>
</head>
<body>

<div class="header">
<h2>ğŸ“Š Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø£Ø¯Ù…Ù†</h2>
</div>

<h3>ğŸ‘¥ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h3>
<div id="users"></div>

<h3>ğŸ Ø§Ù„Ø¬ÙˆØ§Ø¦Ø²</h3>
<div id="prizes"></div>

<h3>ğŸ“¦ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø§Ø³ØªØ¨Ø¯Ø§Ù„</h3>
<div id="redeems"></div>

<div id="participantsBox" style="display:none;background:#000000cc;padding:20px;position:fixed;inset:0;overflow:auto;"></div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import {
  getFirestore,
  collection,
  onSnapshot,
  doc,
  updateDoc,
  getDoc,
  deleteDoc,
  increment,
  setDoc,
  getDocs,
  query,
  where
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDhxOBatW40tfzP2nZVhSjJI55NeY4Nf_o",
  authDomain: "popo-da43c.firebaseapp.com",
  projectId: "popo-da43c",
  storageBucket: "popo-da43c.firebasestorage.app",
  messagingSenderId: "570136899084",
  appId: "1:570136899084:web:2a86be16b0ff2261c98829"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* ================= Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ø£Ø¯Ù…Ù† ================= */

onAuthStateChanged(auth, async(user)=>{

  if(!user){
    location.href="login.html";
    return;
  }

  const snap = await getDoc(doc(db,"users",user.uid));
  if(!snap.exists() || snap.data().isAdmin !== true){
    alert("Ù‡Ø°Ø§ Ø§Ù„Ø­Ø³Ø§Ø¨ Ù„ÙŠØ³ Ø£Ø¯Ù…Ù†");
    location.href="index.html";
    return;
  }

  loadUsers();
  loadPrizes();
  loadRedeems();
});

/* ================= Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ================= */

function loadUsers(){

  onSnapshot(collection(db,"users"), async snapshot=>{

    let html = "";

    for (const docSnap of snapshot.docs){

      const d = docSnap.data();
      const uid = docSnap.id;

      // ğŸ”¥ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ§Øª Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ©
      const partSnap = await getDocs(
        query(collection(db,"prizeParticipants"),
        where("userId","==",uid))
      );

      // ğŸ”¥ Ø­Ø³Ø§Ø¨ Ù…Ø±Ø§Øª Ø§Ù„ÙÙˆØ² Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ©
      const winSnap = await getDocs(
        query(collection(db,"prizes"),
        where("winner","==",d.name || ""))
      );

      // ğŸ”¥ Ø­Ø³Ø§Ø¨ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø§Ø³ØªØ¨Ø¯Ø§Ù„
      const redeemSnap = await getDocs(
        query(collection(db,"redeemRequests"),
        where("userId","==",uid))
      );

      html += `
      <div class="card">
        <img src="${d.photo || 'https://i.imgur.com/6VBx3io.png'}" width="50">
        <b>${d.name || "-"}</b>

        <p>ğŸ’° Ø§Ù„Ø±ØµÙŠØ¯: ${d.walletBalance || 0}</p>
        <p>ğŸ Ù…Ø´Ø§Ø±ÙƒØ§Øª: ${partSnap.size}</p>
        <p>ğŸ† Ù…Ø±Ø§Øª Ø§Ù„ÙÙˆØ²: ${winSnap.size}</p>
        <p>ğŸ’ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø§Ø³ØªØ¨Ø¯Ø§Ù„: ${redeemSnap.size}</p>

        <input type="number" id="points-${uid}" placeholder="Ø¹Ø¯Ø¯ Ø§Ù„Ù†Ù‚Ø§Ø·">

        <button class="blue" onclick="addPoints('${uid}')">
        â• Ø¥Ø¶Ø§ÙØ© Ù†Ù‚Ø§Ø·
        </button>

        <button class="red" onclick="removeUser('${uid}')">
        ğŸ—‘ Ø­Ø°Ù
        </button>
      </div>
      `;
    }

    document.getElementById("users").innerHTML = html;

  });
}

window.addPoints = async(uid)=>{
  const val = document.getElementById(`points-${uid}`).value;
  if(!val) return;

  await updateDoc(doc(db,"users",uid),{
    walletBalance: increment(Number(val))
  });

  alert("ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù†Ù‚Ø§Ø· âœ…");
};

window.removeUser = async(uid)=>{
  if(confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŸ")){
    await deleteDoc(doc(db,"users",uid));
  }
};

/* ================= Ø§Ù„Ø¬ÙˆØ§Ø¦Ø² ================= */

function loadPrizes(){

  onSnapshot(collection(db,"prizes"), snapshot=>{

    let html="";

    snapshot.forEach(docSnap=>{
      const d = docSnap.data();

      html += `
      <div class="card">
        <img src="${d.image}" width="100%">
        <p>${d.currentPoints}/${d.targetPoints}</p>
        <p>Ø§Ù„Ø­Ø§Ù„Ø©: ${d.active ? "Ù…ÙØªÙˆØ­Ø©" : "Ù…ØºÙ„Ù‚Ø©"}</p>

        <button class="blue"
        onclick="viewParticipants('${docSnap.id}')">
        ğŸ“Š Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ†
        </button>

        ${
          d.active
          ? `<button class="green"
              onclick="closePrize('${docSnap.id}')">
              ğŸ”’ Ø¥ØºÙ„Ø§Ù‚ ÙŠØ¯ÙˆÙŠ
             </button>`
          : `<button class="orange"
              onclick="reopenPrize('${docSnap.id}')">
              â™» Ø¥Ø¹Ø§Ø¯Ø© ÙØªØ­
             </button>`
        }

        <button class="red"
        onclick="deletePrize('${docSnap.id}')">
        ğŸ—‘ Ø­Ø°Ù
        </button>
      </div>
      `;
    });

    document.getElementById("prizes").innerHTML = html;
  });
}

/* Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ† ÙˆØ§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø£Ø¹Ù„Ù‰ */

window.viewParticipants = async(prizeId)=>{

  const box = document.getElementById("participantsBox");
  box.style.display="block";
  box.innerHTML="<h3>ğŸ“Š Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ†</h3>";

  const q = query(collection(db,"prizeParticipants"),
                  where("prizeId","==",prizeId));

  const snap = await getDocs(q);

  let usersMap = {};

  snap.forEach(docSnap=>{
    const data = docSnap.data();

    if(!usersMap[data.userId]){
      usersMap[data.userId]={
        name:data.name,
        photo:data.photo,
        totalPoints:0
      };
    }

    usersMap[data.userId].totalPoints += data.points;
  });

  const sorted = Object.entries(usersMap)
  .sort((a,b)=> b[1].totalPoints - a[1].totalPoints);

  sorted.forEach(([uid,user])=>{
    box.innerHTML += `
    <div class="card">
      <img src="${user.photo}" width="50">
      <h4>${user.name}</h4>
      <p>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‚Ø§Ø·: ${user.totalPoints}</p>
    </div>
    `;
  });

  if(sorted.length > 0){

  const top = sorted[0];

  box.innerHTML += `
  <button class="green"
  onclick="chooseWinner('${prizeId}',
  '${top[0]}',
  '${top[1].name}',
  '${top[1].photo}')">
  ğŸ‘‘ Ø§Ø®ØªÙŠØ§Ø± ØµØ§Ø­Ø¨ Ø£Ø¹Ù„Ù‰ Ù†Ù‚Ø§Ø·
  </button>
  `;
}

  box.innerHTML += `
  <button class="red" onclick="closeParticipants()">
  Ø¥ØºÙ„Ø§Ù‚
  </button>
  `;
};

window.closeParticipants=()=>{
  document.getElementById("participantsBox").style.display="none";
};

/* Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙØ§Ø¦Ø² */

window.chooseWinner = async(prizeId,uid,name,photo)=>{

  await updateDoc(doc(db,"prizes",prizeId),{
    active:false,
    winner:name
  });

  await updateDoc(doc(db,"users",uid),{
    totalWins: increment(1)
  });

  await setDoc(doc(db,"liveActivity","current"),{
    type:"winner",
    name:name,
    photo:photo,
    message:"ÙØ§Ø² Ø¨Ø§Ù„Ø¬Ø§Ø¦Ø²Ø© Ø§Ù„ÙƒØ¨Ø±Ù‰ ğŸ†",
    time: Date.now()+Math.random()
  });

  alert("ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙØ§Ø¦Ø² ğŸ‘‘");
  closeParticipants();
};

window.closePrize = async(id)=>{
  await updateDoc(doc(db,"prizes",id),{
    active:false
  });
};

window.reopenPrize = async(id)=>{
  await updateDoc(doc(db,"prizes",id),{
    active:true,
    currentPoints:0,
    winner:""
  });
};

window.deletePrize = async(id)=>{
  if(confirm("Ø­Ø°Ù Ø§Ù„Ø¬Ø§Ø¦Ø²Ø©ØŸ")){
    await deleteDoc(doc(db,"prizes",id));
  }
};

/* ================= Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø§Ø³ØªØ¨Ø¯Ø§Ù„ ================= */

function loadRedeems(){

  onSnapshot(collection(db,"redeemRequests"), snapshot=>{

    let html="";

    snapshot.forEach(docSnap=>{
      const d = docSnap.data();

      html += `
      <div class="card">
        <b>${d.userName}</b>
        <p>ID: ${d.playerId}</p>
        <p>Ø§Ù„Ø­Ø§Ù„Ø©: ${d.status}</p>

        ${
          d.status==="pending"
          ? `<button class="green"
             onclick="approveRedeem('${docSnap.id}','${d.userId}')">
             âœ” Ù…ÙˆØ§ÙÙ‚Ø©
             </button>`
          : ""
        }
      </div>
      `;
    });

    document.getElementById("redeems").innerHTML = html;
  });
}

window.approveRedeem = async(id,uid)=>{

  await updateDoc(doc(db,"redeemRequests",id),{
    status:"approved",
    approvedAt:Date.now()
  });

  await updateDoc(doc(db,"users",uid),{
    totalRedeems: increment(1)
  });

  alert("ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨ âœ…");
};

</script>
</body>
</html>